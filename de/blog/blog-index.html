<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Blog | DVAYD Publishing</title>
    <meta name="description" content="Blog – Beiträge, Updates und Insights von DVAYD Publishing.">
    <link rel="canonical" href="https://yoursite.com/de/blog/">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../../assets/images/favicon.png">
    <link rel="apple-touch-icon" href="../../assets/images/favicon.png">
    
    <!-- Apply theme immediately -->
    <script>
        (function() {
            try {
                const theme = localStorage.getItem('dvayd_theme');
                if (theme === 'dim') {
                    document.documentElement.setAttribute('data-theme', 'dim');
                }
            } catch(e) {}
        })();
    </script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../../assets/css/global.css">
    <link rel="stylesheet" href="../../assets/css/background.css">
    <link rel="stylesheet" href="../../assets/css/header.css">
    <link rel="stylesheet" href="../../assets/css/footer.css">
    <link rel="stylesheet" href="../../assets/css/blog-list.css">
    <link rel="stylesheet" href="../../assets/css/cursor-follower.css">
</head>
<body>
    
    <!-- Header -->
    <div id="header-placeholder"></div>
    
    <!-- Main Content -->
    <main>
        <section class="blog-wrap">
            <div class="blog-hero">
                <h1 class="blog-title">Blog</h1>
                <p class="blog-sub">
                    Neue Beiträge erscheinen automatisch, sobald sie im Google Sheet hinzugefügt werden.
                </p>
            </div>
            
            <div class="blog-controls">
                <input id="q" class="blog-input" type="search" placeholder="Suchen (Titel / Teaser / Tags) …" autocomplete="off">
                <select id="tag" class="blog-select">
                    <option value="">Alle Tags</option>
                </select>
                <div id="count" class="blog-count"></div>
            </div>
            
            <div id="state" class="blog-state">Lade Beiträge …</div>
            <section id="grid" class="blog-grid" aria-live="polite"></section>
        </section>
    </main>
    
    <!-- Footer -->
    <div id="footer-placeholder"></div>
    
    <!-- JavaScript -->
    <script type="module" src="../../assets/js/main.js"></script>
    
    <!-- Blog Script -->
    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS4g1gNsiyY4k2A052LR7EaVUYFqrWGWNITOPqw5bGG_PTogiP84C44VQJpKn-HC2vxHin4fTy_puU0/pub?output=csv";
        
        const els = {
            q: document.getElementById("q"),
            tag: document.getElementById("tag"),
            count: document.getElementById("count"),
            state: document.getElementById("state"),
            grid: document.getElementById("grid"),
        };
        
        let ALL = [];
        
        function esc(str) {
            return String(str ?? "").replace(/[&<>"']/g, m => ({
                "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
            }[m]));
        }
        
        function norm(s) {
            return String(s ?? "").toLowerCase().trim();
        }
        
        function splitTags(s) {
            return String(s ?? "").split(",").map(t => t.trim()).filter(Boolean);
        }
        
        function parseCSV(text) {
            const rows = [];
            let row = [];
            let cur = "";
            let inQuotes = false;
            
            for(let i=0; i<text.length; i++) {
                const c = text[i];
                const n = text[i+1];
                
                if(inQuotes) {
                    if(c === '"' && n === '"') { cur += '"'; i++; }
                    else if(c === '"') { inQuotes = false; }
                    else { cur += c; }
                } else {
                    if(c === '"') { inQuotes = true; }
                    else if(c === ",") { row.push(cur); cur=""; }
                    else if(c === "\n") { row.push(cur); rows.push(row); row=[]; cur=""; }
                    else if(c === "\r") { /* ignore */ }
                    else { cur += c; }
                }
            }
            row.push(cur);
            rows.push(row);
            return rows.filter(r => r.some(cell => String(cell).trim() !== ""));
        }
        
        function fillTagDropdown(posts) {
            const tags = new Set();
            posts.forEach(p => (p.tags || []).forEach(t => tags.add(t)));
            const sorted = Array.from(tags).sort((a,b) => a.localeCompare(b, "de"));
            
            els.tag.innerHTML = 
                `<option value="">Alle Tags</option>` +
                sorted.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join("");
        }
        
        function render(posts) {
            if(!posts.length) {
                els.grid.innerHTML = "";
                els.state.textContent = "Keine Beiträge gefunden.";
                els.state.style.display = "block";
                els.count.textContent = "";
                return;
            }
            
            els.state.style.display = "none";
            els.count.textContent = `${posts.length} Beitrag${posts.length === 1 ? "" : "e"}`;
            
            els.grid.innerHTML = posts.map(p => `
                <article class="blog-card">
                    ${p.cover
                        ? `<img class="blog-cover" src="${esc(p.cover)}" alt="${esc(p.title)}">`
                        : `<div class="blog-cover" aria-hidden="true"></div>`
                    }
                    <div class="blog-card-body">
                        <div class="blog-meta">
                            ${p.date ? `<span>${esc(p.date)}</span>` : ``}
                            ${p.author ? `<span>·</span><span>${esc(p.author)}</span>` : ``}
                            ${p.tags?.[0]
                                ? `<span class="blog-pill" title="${esc(p.tags.join(", "))}">
                                    ${esc(p.tags[0])}${p.tags.length>1 ? " +" + (p.tags.length-1) : ""}
                                </span>`
                                : ``
                            }
                        </div>
                        
                        <h2 class="blog-h2">${esc(p.title)}</h2>
                        <p class="blog-excerpt">${esc(p.excerpt || "")}</p>
                        
                        <div class="blog-row">
                            <a class="blog-btn" href="post.html?slug=${encodeURIComponent(p.slug)}">
                                Lesen <span aria-hidden="true">→</span>
                            </a>
                        </div>
                    </div>
                </article>
            `).join("");
        }
        
        function applyFilters() {
            const q = norm(els.q.value);
            const tag = els.tag.value;
            
            let out = ALL;
            
            if(tag) {
                out = out.filter(p => (p.tags || []).includes(tag));
            }
            if(q) {
                out = out.filter(p => {
                    const hay = norm([p.title, p.excerpt, (p.tags||[]).join(" ")].join(" "));
                    return hay.includes(q);
                });
            }
            
            render(out);
        }
        
        (async function init() {
            try {
                els.state.textContent = "Lade Beiträge …";
                
                const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
                const csv = await res.text();
                
                const rows = parseCSV(csv);
                if(rows.length < 2) throw new Error("CSV has no data rows");
                
                const header = rows[0].map(h => norm(h));
                const idx = (name) => header.indexOf(norm(name));
                
                const posts = rows.slice(1).map(r => ({
                    slug:   r[idx("slug")] || "",
                    title:  r[idx("title")] || "",
                    excerpt:r[idx("excerpt")] || r[idx("content")] || "",
                    date:   r[idx("date")] || "",
                    author: r[idx("author")] || "",
                    cover:  r[idx("cover")] || "",
                    tags:   splitTags(r[idx("tags")] || ""),
                })).filter(p => p.slug && p.title);
                
                posts.sort((a,b) => (b.date || "").localeCompare(a.date || ""));
                
                ALL = posts;
                fillTagDropdown(ALL);
                render(ALL);
                
                els.q.addEventListener("input", applyFilters);
                els.tag.addEventListener("change", applyFilters);
                
            } catch(err) {
                console.error(err);
                els.grid.innerHTML = "";
                els.state.style.display = "block";
                els.state.textContent = "Fehler beim Laden der Beiträge. Prüfe: (1) Sheet ist 'Published', (2) Header heißt slug,title,excerpt,content,date,author,cover,tags.";
            }
        })();
    </script>
    
    <!-- Cursor Follower -->
    <script type="module">
        window.addEventListener('load', () => {
            setTimeout(() => {
                import('../../assets/js/cursor-follower.js')
                    .then(module => module.initCursorFollower())
                    .catch(err => console.log('Cursor follower skipped:', err));
            }, 500);
        });
    </script>
    
</body>
</html>